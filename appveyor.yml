# For information on these settings, see:
#    https://www.appveyor.com/docs/build-configuration/
#    https://www.appveyor.com/docs/appveyor-yml/
#
# Notes:
#   - Minimal appveyor.yml file is an empty file. All sections are optional.
#   - Indent each level of configuration with 2 spaces. Do not use tabs!
#   - All section names are case-sensitive.
#   - Section names should be unique on each level.

# The following is supported by default. See:
#   https://www.appveyor.com/docs/how-to/filtering-commits/
#
#skip_commits:
#  message: /\[appveyor skip\]/|/\[skip appveyor\]/

image: Visual Studio 2017

branches:
  only:
    - master

#platform:
#  - Win32
#  - x64

#configuration:
#  - Debug
#  - Release

environment:
  matrix:
    - platform: x64
      configuration: Debug
    - platform: x64
      configuration: Release
    - platform: Win32
      configuration: Debug
    - platform: Win32
      configuration: Release

install:
  - ps: choco install doxygen.portable
  - ps: choco install graphviz
  - cmake --version
  - git submodule update --init --recursive

#test_script:
#- ps: |
#    If ($env:PLATFORM -Match "Win32") {
#      $env:PLAYRHO_EXE="x32"
#    }
#    If ($env:PLATFORM -Match "x64") {
#      $env:PLAYRHO_EXE="x64"
#    }
#    Start-Process -FilePath "\projects\playrho\Build\vs2017\bin\$env:PLAYRHO_EXE\$env:CONFIGURATION\HelloWorld.exe" -RedirectStandardOutput "Hello.txt" -Wait -NoNewWindow

before_build:
  - echo %APPVEYOR_BUILD_FOLDER%
  - cmd: if "%platform%"=="Win32" set generator=Visual Studio 15 2017
  - cmd: if "%platform%"=="x64" set generator=Visual Studio 15 2017 Win64
  - cmd: if "%platform%"=="Win32" call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars32.bat"
  - cmd: if "%platform%"=="x64" call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
  - echo %generator%
  - cmd: if not exist "%APPVEYOR_BUILD_FOLDER%\Build-%platform%" md %APPVEYOR_BUILD_FOLDER%\Build-%platform%

build_script:
  - cd %APPVEYOR_BUILD_FOLDER%\Build-%platform%
  - cmake -G"%generator%" -DCMAKE_BUILD_TYPE=%configuration% -DPLAYRHO_BUILD_HELLOWORLD=ON -DPLAYRHO_BUILD_UNIT_TESTS=ON ..
  - cmake --build . --config "%configuration%"
  - cd ..

#build:
#  project: Build/vs2017/PlayRho.sln
#  verbosity: normal

after_build:
  - set PATH=c:\Program Files (x86)\graphviz2.38\bin;%PATH%
  - cd %APPVEYOR_BUILD_FOLDER%\Documentation
  - doxygen Doxyfile
  - cd ..
  - 7z a binaries-x64.zip Build-x64\*\*\*.lib
  - 7z a binaries-Win32.zip Build-Win32\*\*\*.exe

artifacts:
  - path: Documentation\API
    name: API-docs
  - path: binaries-x64.zip
    name: binaries-x64
  - path: binaries-Win32.zip
    name: binaries-Win32
  - path: Build\vs2017\bin
    name: Binary Executables
